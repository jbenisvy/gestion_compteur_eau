{% extends 'base.html.twig' %}
{% block title %}Saisie des index ‚Äì {{ annee }}{% endblock %}

{% block body %}
<style>
:root{
  --bg:#e6f2ff; --panel:#fff; --muted:#6b7280; --line:#e5e7eb;
  --brand:#2563eb; --hot:#fbe4e6; --cold:#e7f0ff; --hot-border:#f5b0bd; --cold-border:#b5cffc;
}
.page{max-width:1200px;margin:0 auto;padding:16px;}
h1{margin:10px 0 8px 0; font-size:28px;}
/* Toolbar Lot/Ann√©e */
.toolbar{display:flex;gap:10px;align-items:flex-end;background:#eaf2ff;padding:10px 12px;border-radius:10px;margin-bottom:12px;}
.toolbar label{font-weight:600;font-size:14px;color:#111}
.toolbar select{padding:6px 8px;border:1px solid var(--line);border-radius:8px;}
.btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:9px 14px;cursor:pointer;}
.btn[disabled]{opacity:.5;cursor:not-allowed;}
/* Grille */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media (max-width:960px){.grid2{grid-template-columns:1fr;}}
.block{border-radius:14px;overflow:hidden;}
.block.hot{background:linear-gradient(0deg,#fff,var(--hot));border:1px solid var(--hot-border);}
.block.cold{background:linear-gradient(0deg,#fff,var(--cold));border:1px solid var(--cold-border);}
.block .head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);}
.block .inner{padding:10px 12px}
.row{border:1px dashed #e2e8f0;border-radius:10px;padding:10px;margin-bottom:10px;background:#fff9;}
.meta{font-size:12px;color:#6b7280}
.lbl{font-weight:600}
.small input, .small select, .small textarea{width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:8px;font-size:14px;min-width:0;}
/* Ligne 1 (commune) */
.rowgrid-top{
  display:grid;
  grid-template-columns: 110px 90px minmax(180px,1fr) 110px 120px 110px;
  gap:10px; align-items:center;
}
@media (max-width:1100px){ .rowgrid-top{grid-template-columns: 120px 90px 1fr 100px 110px 100px;} }
@media (max-width:900px){ .rowgrid-top{grid-template-columns:1fr 1fr; row-gap:6px;} }
/* Ligne 2 (remplacement) : 2 colonnes pour bien voir les 4 champs */
.rowgrid-replace{
  display:grid;
  grid-template-columns: repeat(2, minmax(240px,1fr));
  gap:10px; align-items:end; margin-top:8px;
}
@media (max-width:700px){ .rowgrid-replace{grid-template-columns:1fr;} }
/* Conso */
.conso{text-align:right;}
.conso .v{font-weight:800;font-size:18px}
.empty{color:#9ca3af;font-style:italic;padding:12px}
.totals{margin-top:12px;padding:12px;border-radius:12px;background:#f8fafc;border:1px solid var(--line)}
.badge-ro{display:inline-flex;align-items:center;gap:8px;background:#fff3cd;border:1px solid #ffe69c;color:#7a5b00;padding:6px 10px;border-radius:8px;font-size:14px;}
.badge-ro .dot{width:8px;height:8px;border-radius:50%;background:#f59e0b;}
/* Lien num√©ro compteur */
.compteur-trigger{display:inline-block; font-weight:600; text-decoration:none; border-bottom:1px dashed #888;}
.compteur-trigger:hover{text-decoration:underline;}
.visually-hidden{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px, 1px, 1px, 1px);}
</style>

<div class="page">

  {# ---- Barre Lot / Ann√©e ---- #}
  <div class="toolbar">
    <div>
      <label for="sel_lot">Lot</label><br>
      <select id="sel_lot">
        {% for l in allLots %}
          <option value="{{ l.id }}" {{ l.id == lot.id ? 'selected' : '' }}>
            #{{ l.id }} ‚Äî {{ attribute(l,'emplacement') is defined ? l.emplacement : 'Lot' }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="sel_annee">Ann√©e</label><br>
      <select id="sel_annee">
        {% for a in annees %}
          <option value="{{ a }}" {{ a == annee ? 'selected' : '' }}>{{ a }}</option>
        {% endfor %}
      </select>
    </div>
    <div><button id="btn_go" class="btn">Aller</button></div>
  </div>

  <h1>üíß Saisie des index ‚Äì {{ annee }}</h1>
  <p style="color:#374151;margin:0 0 12px 0">
    {% if copro %} Copropri√©taire : <b>{{ copro.nom ?? '' }} {{ copro.prenom ?? '' }}</b> ‚Ä¢ {% endif %}
    Lot : <b>#{{ lot.id }}</b>
    {% if attribute(lot,'tantiemes') is defined and lot.tantiemes is not null %} ‚Ä¢ Tanti√®mes : <b>{{ lot.tantiemes }}</b>{% endif %}
    {% if attribute(lot,'tantieme') is defined and lot.tantieme is not null %} ‚Ä¢ Tanti√®mes : <b>{{ lot.tantieme }}</b>{% endif %}
    {% if attribute(lot,'occupant') is defined and lot.occupant is not null %} ‚Ä¢ Occupant : <b>{{ lot.occupant }}</b>{% endif %}
    {% if attribute(lot,'typeAppartement') is defined and lot.typeAppartement is not null %} ‚Ä¢ Type : <b>{{ lot.typeAppartement }}</b>{% endif %}
  </p>

  {# Bandeau lecture seule si l‚Äôann√©e n‚Äôest pas √©ditable #}
  {% if not isEditable %}
    <div class="badge-ro" style="margin:8px 0 14px 0;">
      <span class="dot"></span>
      Ann√©e {{ annee }} en lecture seule (√©dition d√©sactiv√©e).{% if anneeActive is defined %} Ann√©e active : <b>{{ anneeActive }}</b>.{% endif %}
    </div>
  {% endif %}

  {% for type, messages in app.flashes %}
    {% for message in messages %}
      <div class="row" style="border-style:solid;border-color:#93c5fd;background:#eff6ff">{{ message }}</div>
    {% endfor %}
  {% endfor %}

  {# IMPORTANT : pas de render_rest automatique √† la fin #}
  {{ form_start(form, { attr: { autocomplete: 'off', enctype: 'multipart/form-data' } }) }}

  <div class="grid2">
    {# ----- Eau Chaude ----- #}
    <div class="block hot">
      <div class="head"><div>Compteurs Eau Chaude</div><div class="meta">Total bloc : <b id="total_cuisine_chaude">0</b> + <b id="total_sdb_chaude">0</b></div></div>
      <div class="inner">
        {% set printed = 0 %}
        {% for idx, item in items %}
          {% set piece = item.piece ?? '' %}
          {% set type  = item.typeEau ?? '' %}
          {% if type == 'chaude' %}
            {% set printed = printed + 1 %}
            <div class="row small">
              <div class="rowgrid-top">
                <div class="lbl">
                  {{ piece|capitalize }}
                  <br>
                  {# ‚¨áÔ∏è Num√©ro cliquable (depuis le DTO) #}
                  <a href="#"
                     class="compteur-trigger"
                     data-compteur-id="{{ item.compteurId }}"
                     title="Cliquer pour ajouter/remplacer la photo">
                    {{ item.compteurNumero }}
                  </a>
                </div>
                <div class="meta">N-1 : <b class="n1">{{ item.indexPrevious ?? 0 }}</b></div>
                <div class="field-etat">{{ form_row(form.items[idx].etat, {'label':'√âtat'}) }}</div>
                <div class="field-indexN">{{ form_row(form.items[idx].indexN, {'label':'N'}) }}</div>
                <div class="field-forfait">{{ form_row(form.items[idx].forfait, {'label':'Forfait'}) }}</div>
                <div class="conso">
                  <div class="meta">Conso calcul√©e</div>
                  <div class="v cons-val" data-piece="{{ piece }}" data-type="{{ type }}">0</div>
                </div>
              </div>
              <div class="rowgrid-replace">
                <div class="field-dateInstallation">{{ form_row(form.items[idx].dateInstallation, {'label':"Date d'installation"}) }}</div>
                <div class="field-numeroNouveauCompteur">{{ form_row(form.items[idx].numeroNouveauCompteur, {'label':"N¬∞ nouveau compteur"}) }}</div>
                <div class="field-indexDemonte">{{ form_row(form.items[idx].indexDemonte, {'label':'Index ancien (d√©mont√©)'}) }}</div>
                <div class="field-indexNouveau">{{ form_row(form.items[idx].indexNouveau, {'label':'Index nouveau'}) }}</div>
                <div class="comment" style="grid-column:1/-1">{{ form_row(form.items[idx].commentaire, {'label':'Commentaire'}) }}</div>

                {# ‚¨áÔ∏è Input fichier cach√© li√© √† ce compteur (data-compteur-id depuis DTO) #}
                <div class="visually-hidden">
                  {{ form_widget(form.items[idx].photoFile, {
                    attr: {
                      'data-compteur-id': item.compteurId,
                      class: 'photo-input'
                    }
                  }) }}
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        {% if printed == 0 %}<div class="empty">Aucun compteur dans ce bloc.</div>{% endif %}
      </div>
    </div>

    {# ----- Eau Froide ----- #}
    <div class="block cold">
      <div class="head"><div>Compteurs Eau Froide</div><div class="meta">Total bloc : <b id="total_cuisine_froide">0</b> + <b id="total_sdb_froide">0</b></div></div>
      <div class="inner">
        {% set printed = 0 %}
        {% for idx, item in items %}
          {% set piece = item.piece ?? '' %}
          {% set type  = item.typeEau ?? '' %}
          {% if type == 'froide' %}
            {% set printed = printed + 1 %}
            <div class="row small">
              <div class="rowgrid-top">
                <div class="lbl">
                  {{ piece|capitalize }}
                  <br>
                  <a href="#"
                     class="compteur-trigger"
                     data-compteur-id="{{ item.compteurId }}"
                     title="Cliquer pour ajouter/remplacer la photo">
                    {{ item.compteurNumero }}
                  </a>
                </div>
                <div class="meta">N-1 : <b class="n1">{{ item.indexPrevious ?? 0 }}</b></div>
                <div class="field-etat">{{ form_row(form.items[idx].etat, {'label':'√âtat'}) }}</div>
                <div class="field-indexN">{{ form_row(form.items[idx].indexN, {'label':'N'}) }}</div>
                <div class="field-forfait">{{ form_row(form.items[idx].forfait, {'label':'Forfait'}) }}</div>
                <div class="conso">
                  <div class="meta">Conso calcul√©e</div>
                  <div class="v cons-val" data-piece="{{ piece }}" data-type="{{ type }}">0</div>
                </div>
              </div>
              <div class="rowgrid-replace">
                <div class="field-dateInstallation">{{ form_row(form.items[idx].dateInstallation, {'label':"Date d'installation"}) }}</div>
                <div class="field-numeroNouveauCompteur">{{ form_row(form.items[idx].numeroNouveauCompteur, {'label':"N¬∞ nouveau compteur"}) }}</div>
                <div class="field-indexDemonte">{{ form_row(form.items[idx].indexDemonte, {'label':'Index ancien (d√©mont√©)'}) }}</div>
                <div class="field-indexNouveau">{{ form_row(form.items[idx].indexNouveau, {'label':'Index nouveau'}) }}</div>
                <div class="comment" style="grid-column:1/-1">{{ form_row(form.items[idx].commentaire, {'label':'Commentaire'}) }}</div>

                <div class="visually-hidden">
                  {{ form_widget(form.items[idx].photoFile, {
                    attr: {
                      'data-compteur-id': item.compteurId,
                      class: 'photo-input'
                    }
                  }) }}
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        {% if printed == 0 %}<div class="empty">Aucun compteur dans ce bloc.</div>{% endif %}
      </div>
    </div>
  </div>

  <div class="totals">
    <h3 style="margin:0 0 8px 0;">Totaux</h3>
    <div style="display:flex;gap:24px;flex-wrap:wrap;">
      <div>Cuisine ‚Äì Chaude : <b id="t_cuisine_chaude">0</b></div>
      <div>SDB ‚Äì Chaude : <b id="t_sdb_chaude">0</b></div>
      <div>Total Eau chaude : <b id="t_global_chaude">0</b></div>
      <div>Cuisine ‚Äì Froide : <b id="t_cuisine_froide">0</b></div>
      <div>SDB ‚Äì Froide : <b id="t_sdb_froide">0</b></div>
      <div>Total Eau froide : <b id="t_global_froide">0</b></div>
      <div style="flex:1 0 100%"></div>
      <div>Total g√©n√©ral : <b id="t_global_total">0</b></div>
    </div>
    <div style="margin-top:10px;">
      <button class="btn" {{ not isEditable ? 'disabled' : '' }}>üíæ Enregistrer</button>
    </div>
  </div>

  {# ‚¨áÔ∏è √âvite l‚Äôinjection des champs non rendus (pas de rest automatique) #}
  {{ form_end(form, { render_rest: false }) }}
</div>

<script>
(function(){
  // ---- Navigation Lot/Ann√©e ----
  const goBtn=document.getElementById('btn_go');
  const selLot=document.getElementById('sel_lot');
  const selAn =document.getElementById('sel_annee');
  const protoUrl="{{ path('saisie_index_form', { lotId: 999999, annee: 1999 }) }}";
  goBtn?.addEventListener('click', ()=> {
    const lotId=selLot?selLot.value:'{{ lot.id }}';
    const annee=selAn?selAn.value:'{{ annee }}';
    const url=protoUrl.replace('999999', lotId).replace('1999', annee);
    window.location.href=url;
  });

  function toInt(v){ v=(v??'').toString().trim(); const n=parseInt(v,10); return isNaN(n)?0:n; }

  function toggleFields(card, etatTxt){
    etatTxt=(etatTxt||'').toLowerCase();
    const show = sel => { const el=card.querySelector(sel); if(el) el.style.removeProperty('display'); };
    const hide = sel => { const el=card.querySelector(sel); if(el) el.style.display='none'; };

    hide('.field-indexN'); hide('.field-forfait');
    hide('.field-dateInstallation'); hide('.field-numeroNouveauCompteur');
    hide('.field-indexDemonte'); hide('.field-indexNouveau');

    if(etatTxt.includes('supprim')) { /* rien */ }
    else if(etatTxt.includes('forfait')) { show('.field-forfait'); }
    else if(etatTxt.includes('remplac') || etatTxt.includes('d√©mont') || etatTxt.includes('demonte')) {
      show('.field-dateInstallation'); show('.field-numeroNouveauCompteur');
      show('.field-indexDemonte');    show('.field-indexNouveau');
    } else {
      show('.field-indexN');
    }
  }

  function recompute(){
    const blocTotals={cuisine_chaude:0,cuisine_froide:0,sdb_chaude:0,sdb_froide:0};
    let tHot=0,tCold=0,tAll=0;

    document.querySelectorAll('.row').forEach(card=>{
      const consEl=card.querySelector('.cons-val'); if(!consEl) return;
      const piece=consEl.dataset.piece || '';
      const type =consEl.dataset.type  || '';

      const prev=toInt(card.querySelector('.n1')?.textContent);
      const sel =card.querySelector('.field-etat select');
      const etat=(sel && sel.options[sel.selectedIndex]) ? sel.options[sel.selectedIndex].text.toLowerCase() : '';

      const getInput=(suffix)=>card.querySelector(`input[id$="${suffix}"]`);
      const n  = toInt(getInput('_indexN')?.value);
      const f  = toInt(getInput('_forfait')?.value);
      const dm = toInt(getInput('_indexDemonte')?.value);
      const nw = toInt(getInput('_indexNouveau')?.value);

      // Pr√©remplir "ancien" avec N-1 si vide et remplac√©
      if ((dm===0 || getInput('_indexDemonte')?.value==='') 
          && prev>0 && (etat.includes('remplac') || etat.includes('d√©mont') || etat.includes('demonte'))) {
        const dmInput=getInput('_indexDemonte');
        if (dmInput && dmInput.value==='') dmInput.value = String(prev);
      }

      toggleFields(card, etat);

      let cons=0;
      if(etat.includes('supprim')) cons=0;
      else if(etat.includes('forfait')) cons=f;
      else if(etat.includes('remplac') || etat.includes('d√©mont') || etat.includes('demonte')){
        cons = Math.max(0, dm - prev) + Math.max(0, nw); // (ancien - N-1) + nouveau
      } else {
        cons = Math.max(0, n - prev);
      }

      consEl.textContent=String(cons);

      const key=`${piece}_${type}`;
      if(key in blocTotals){
        blocTotals[key]+=cons;
        if(type==='chaude') tHot+=cons;
        if(type==='froide') tCold+=cons;
        tAll+=cons;
      }else{ tAll+=cons; }
    });

    const ids={
      total_cuisine_chaude:blocTotals.cuisine_chaude, total_sdb_chaude:blocTotals.sdb_chaude,
      total_cuisine_froide:blocTotals.cuisine_froide, total_sdb_froide:blocTotals.sdb_froide,
      t_cuisine_chaude:blocTotals.cuisine_chaude, t_sdb_chaude:blocTotals.sdb_chaude,
      t_cuisine_froide:blocTotals.cuisine_froide, t_sdb_froide:blocTotals.sdb_froide,
      t_global_chaude:tHot, t_global_froide:tCold, t_global_total:tAll
    };
    Object.entries(ids).forEach(([id,val])=>{ const el=document.getElementById(id); if(el) el.textContent=String(val); });
  }

  document.addEventListener('input', e=>{ if(e.target.matches('input, select, textarea')) recompute(); });
  document.addEventListener('change', e=>{ if(e.target.matches('input, select')) recompute(); });

  // Premier passage
  document.querySelectorAll('.row').forEach(card=>{
    const sel=card.querySelector('.field-etat select');
    const et=(sel && sel.options[sel.selectedIndex]) ? sel.options[sel.selectedIndex].text.toLowerCase() : '';
    toggleFields(card, et);
  });
  recompute();

  // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è Num√©ro cliquable -> ouvre l'input fichier correspondant
  document.querySelectorAll('.compteur-trigger').forEach(function (link) {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const id = this.getAttribute('data-compteur-id');
      const input = document.querySelector('input.photo-input[data-compteur-id="'+id+'"]');
      if (input) { input.click(); }
    });
  });
  document.querySelectorAll('input.photo-input').forEach(function (input) {
    input.addEventListener('change', function () {
      const id   = this.getAttribute('data-compteur-id');
      const link = document.querySelector('.compteur-trigger[data-compteur-id="'+id+'"]');
      if (link && this.files && this.files[0]) {
        link.setAttribute('title', 'S√©lectionn√© : ' + this.files[0].name);
      }
    });
  });
  // ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è
})();
</script>
{% endblock %}
