{% extends 'base.html.twig' %}

{% block title %}Référentiel compteurs{% endblock %}

{% block body %}
<section class="hero">
  <div>
    <h1>Référentiel des compteurs</h1>
    <p>Éditez ici les numéros de compteur de référence (EC/EF cuisine/sdb) pour chaque lot.</p>
    <p>Les valeurs modifiées sont reprises dans la saisie par lot.</p>
  </div>
  <div class="card">
    <h3>Import / Export CSV</h3>
    <p><a class="btn btn-ghost" href="{{ path('admin_compteurs_reference_export') }}">Exporter le CSV</a></p>
    <form method="post" enctype="multipart/form-data" action="{{ path('admin_compteurs_reference_import') }}">
      <input type="hidden" name="_token" value="{{ csrf_token('admin_compteurs_reference_import') }}">
      <div class="form-row">
        <label for="csv_file">Fichier CSV</label>
        <input id="csv_file" type="file" name="csv_file" accept=".csv,text/csv" required>
      </div>
      <button class="btn btn-primary" type="submit">Importer</button>
    </form>
  </div>
</section>

<section class="card compteur-reference-section" style="margin-top: 20px;">
  <form id="compteurs-reference-form" method="post" action="{{ path('admin_compteurs_reference') }}" enctype="multipart/form-data">
    <input type="hidden" name="_token" value="{{ csrf_token('admin_compteurs_reference_save') }}">
    <div class="compteur-reference-toolbar">
      <button class="btn btn-primary" type="submit">Enregistrer les modifications</button>
    </div>
    <div class="table-wrap">
      <table class="table compteur-reference-table">
        <thead>
          <tr>
            <th>Lot</th>
            <th>Copropriétaire (actuel)</th>
            <th>EC SDB</th>
            <th>EC Cuisine</th>
            <th>EF SDB</th>
            <th>EF Cuisine</th>
            <th>Photos</th>
          </tr>
        </thead>
        <tbody>
          {% for lot in lots %}
            {% set lotSlots = byLotAndSlot[lot.id] ?? {} %}
            {% set copro = lot.getCoproprietaire(date()) %}
            <tr>
              <td><strong>Lot {{ lot.numeroLot }}</strong></td>
              <td>{{ copro ? copro.nomComplet : 'N/A' }}</td>
              {% for slot in slots %}
                {% set compteur = lotSlots[slot] ?? null %}
                <td>
                  <input
                    type="text"
                    name="rows[{{ lot.id }}][{{ slot }}]"
                    value="{{ compteur ? (compteur.numeroSerie ?? '') : '' }}"
                    placeholder="{{ compteur ? 'N° compteur' : 'Compteur absent' }}"
                    {{ compteur ? '' : 'disabled' }}
                    class="table-input"
                  >
                  <input
                    type="file"
                    name="photos[{{ lot.id }}][{{ slot }}]"
                    accept="image/*"
                    {{ compteur ? '' : 'disabled' }}
                    style="margin-top:6px;max-width: 220px;"
                  >
                  {% if compteur and compteur.photo %}
                    <div style="margin-top:4px;">
                      <a class="badge" href="{{ compteur.photo }}" target="_blank" rel="noopener">Photo actuelle</a>
                    </div>
                  {% endif %}
                </td>
              {% endfor %}
              <td>
                {% for slot in slots %}
                  {% set compteur = lotSlots[slot] ?? null %}
                  {% if compteur %}
                    <a class="badge" href="{{ path('compteur_photo_history', { id: compteur.id }) }}" target="_blank" rel="noopener">{{ slot|replace({'_':' '}) }}</a>
                    <button
                      type="submit"
                      name="removePhotos[{{ lot.id }}][{{ slot }}]"
                      value="1"
                      class="badge"
                      style="border:none;cursor:pointer;{{ compteur.photo ? '' : 'opacity:.45;cursor:not-allowed;' }}"
                      {{ compteur.photo ? '' : 'disabled' }}
                      onclick="return confirm('Supprimer la photo active de {{ slot|replace({'_':' '}) }} pour le lot {{ lot.numeroLot }} ?');"
                    >Suppr.</button>
                  {% endif %}
                {% endfor %}
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="7">Aucun lot trouvé.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
</section>
<button class="btn btn-primary compteur-reference-floating-save" type="submit" form="compteurs-reference-form">
  Enregistrer les modifications
</button>
{% endblock %}
